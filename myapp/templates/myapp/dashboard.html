
{% extends "myapp/base.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
console.log("DASHBOARD JS LOADED");
</script>

<!-- Stats Row -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-0 p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Total Campaigns</div>
          <div class="h3 mb-0 kpi-number d-none"
     data-value="{{ total_campaigns }}">
  0
</div>

<div class="skeleton skeleton-title"></div>


        </div>
        <div class="fs-1 text-primary">‚úâÔ∏è</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Emails Sent</div>
          <div
  class="h3 mb-0 kpi-number"
  data-value="{{ emails_sent }}"
>
  0
</div>

        </div>
        <div class="fs-1 text-primary">üì®</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Open Rate</div>
          <div
  class="h3 mb-0 kpi-number"
  data-value="{{ open_rate }}"
  data-suffix="%"
>
  0%
</div>

        </div>
        <div class="fs-1 text-primary">üëÅÔ∏è</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-0 p-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">Click Rate</div>
          <div
  class="h3 mb-0 kpi-number"
  data-value="{{ click_rate }}"
  data-suffix="%"
>
  0%
</div>

        </div>
        <div class="fs-1 text-primary">üñ±Ô∏è</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Recent Campaigns Table -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Recent Campaigns</h5>
          <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Template</th>
                <th>Status</th>
                <th>Scheduled Date</th>
                <th class="text-end">Sent Emails</th>
                <th class="text-end">Actions</th>

              </tr>
            </thead>
            <tbody>
  {% for c in recent_campaigns %}
  <tr>
    <td class="fw-semibold">{{ c.name }}</td>

    <td>
      {% if c.template %}
        {{ c.template.name }}
      {% else %}
        <span class="text-muted">‚Äî</span>
      {% endif %}
    </td>

    <td>
      <span class="badge
        {% if c.status == 'sent' %} bg-success
        {% elif c.status == 'scheduled' %} bg-primary
        {% else %} bg-warning text-dark {% endif %}">
        {{ c.status|title }}
      </span>
    </td>

    <td>
  {% if c.scheduled_time %}
    {{ c.scheduled_time|date:"M d, Y" }}
  {% else %}
    <span class="text-muted">‚Äî</span>
  {% endif %}
</td>


    <td class="text-end">{{ c.sent_count }}</td>

    <td class="text-end">
  {% if c.status != "sent" %}
   <form method="post" action="{% url 'campaign_send' c.id %}" style="display:inline;">
  {% csrf_token %}
  <button type="submit" class="btn btn-sm btn-success">
    Send
  </button>
</form>

  {% else %}
    <span class="text-muted">Sent</span>
  {% endif %}
</td>

  </tr>
  {% empty %}
  <tr>
    <td colspan="6" class="text-muted">No campaigns yet</td>
  </tr>
  {% endfor %}
</tbody>

          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3">Quick Actions</h5>

      <a href="{% url 'campaign_create' %}" class="btn btn-primary w-100 mb-2 action-btn">
  <span class="me-2">‚ûï</span> Create New Campaign
</a>

<a href="{% url 'template_list' %}" class="btn btn-primary w-100 mb-2 action-btn">
  <span class="me-2">üìù</span> Manage Email Templates
</a>

<a href="{% url 'recipient_list' %}" class="btn btn-primary w-100 mb-2 action-btn">
  <span class="me-2">üë•</span> Manage Recipients
</a>

<a href="{% url 'recipient_import' %}" class="btn btn-outline-primary w-100 action-btn">
  <span class="me-2">‚¨ÜÔ∏è</span> Import Recipients
</a>





      </div>
    </div>
  </div>
</div>

<!-- Charts Row (placeholder boxes for now) -->
<div class="row g-4 mt-1">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h4 class="mb-3">Open & Click Rates</h4>
<div style="height:350px; width:100%;">
  <canvas id="openClickChart"></canvas>
</div>


      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3">Email Performance</h5>
        <div class="bg-light rounded" style="height: 240px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  console.log("Chart script running");

  const canvas = document.getElementById('openClickChart');
  if (!canvas) {
    console.error("Canvas not found");
    return;
  }

  const ctx = canvas.getContext('2d');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Opens',
          data: [],
          borderColor: '#4CAF50',
          backgroundColor: 'rgba(76,175,80,0.18)',
          fill: true,
          tension: 0.45,
          pointRadius: 4,
          pointHoverRadius: 8,
          borderWidth: 3
        },
        {
          label: 'Clicks',
          data: [],
          borderColor: '#FF9800',
          backgroundColor: 'rgba(255,152,0,0.18)',
          fill: true,
          tension: 0.45,
          pointRadius: 4,
          pointHoverRadius: 8,
          borderWidth: 3
        }
      ]
    },

    options: {
      responsive: true,
      maintainAspectRatio: false,

      animation: {
        duration: 900,
        easing: 'easeOutQuart'
      },

      interaction: {
        mode: 'index',
        intersect: false
      },

      plugins: {
        tooltip: {
          backgroundColor: '#111827',
          titleColor: '#fff',
          bodyColor: '#e5e7eb',
          padding: 12,
          cornerRadius: 8
        },
        legend: {
          labels: {
            usePointStyle: true,
            boxWidth: 10
          }
        }
      },

      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true }
      }
    }
  });

  function loadLiveData() {
    fetch('/api/live-stats/')

      .then(res => res.json())
      .then(data => {
        chart.data.labels = data.labels;
        chart.data.datasets[0].data = data.opens;
        chart.data.datasets[1].data = data.clicks;
        chart.update();
      });
  }

  loadLiveData();
  setInterval(loadLiveData, 5000);

});
</script>

<style>
/* Micro-interaction for dashboard action buttons */
.action-btn {
  transition: all 0.25s ease;
  position: relative;
}

.action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.action-btn:active {
  transform: translateY(0);
  box-shadow: none;
}
</style>

<script>
document.querySelectorAll(".kpi-number").forEach(el => {
  const value = el.dataset.value;
  const suffix = el.dataset.suffix || "";

  if (value !== undefined) {
    el.textContent = value + suffix;
    el.classList.remove("d-none");

    const skeleton = el.nextElementSibling;
    if (skeleton && skeleton.classList.contains("skeleton")) {
      skeleton.remove();
    }
  }
});

</script>


{% endblock %}
