{% extends "myapp/base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Manage Email Templates</h2>
  <a class="btn btn-primary" href="{% url 'template_create' %}">
    + New Template
  </a>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Subject</th>
            <th>Created</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>

        {% for t in templates %}
          <tr>
            <td class="fw-semibold">{{ t.name }}</td>
            <td>{{ t.subject }}</td>
            <td>{{ t.created_at|date:"M d, Y" }}</td>
            <td class="text-end">

              <a class="btn btn-sm btn-outline-primary"
                 href="{% url 'template_edit' t.pk %}">
                Edit
              </a>

              {% if request.user.is_staff %}
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteModal"
                  data-name="{{ t.name }}"
                  data-url="{% url 'template_delete' t.id %}">
                  Delete
                </button>
              {% else %}
                <span class="text-muted small ms-2">
                  No permission
                </span>
              {% endif %}

            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-muted text-center">
              No templates yet
            </td>
          </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- âœ… SINGLE CONFIRM DELETE MODAL -->
<!-- ============================= -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">

      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">
          Delete template
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p class="mb-2">
          Delete <strong id="deleteTemplateName"></strong>?
        </p>
        <small class="text-danger">
          This action cannot be undone.
        </small>
      </div>

      <div class="modal-footer border-0 justify-content-center">
        <button type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>

        <form method="post" id="deleteForm">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            Yes, delete
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- ============================= -->
<!-- MODAL SCRIPT -->
<!-- ============================= -->
<script>
const deleteModal = document.getElementById("deleteModal");

deleteModal.addEventListener("show.bs.modal", function (event) {
  const button = event.relatedTarget;
  const name = button.getAttribute("data-name");
  const url = button.getAttribute("data-url");

  document.getElementById("deleteTemplateName").textContent = name;
  document.getElementById("deleteForm").action = url;
});
</script>

{% endblock %}
